var exceptionDB=["postgres","template0","template1"],exceptionColumns=["uuid"],readOnlyDB=["sonde"],displayName=["name","tenant_name","sg_name","subnet_name","ecs_name","kp_name","vpc_name","uuid"],busy=!1,exceptionTables=["map"],waitFor=1,forbiddenChar=["#","%","&","+","[","]","{","}","'",'"',"\\"],isInExceptionTables=function(e){ret=!1;for(let t=0;t<exceptionTables.length;t++)if(e.startsWith(exceptionTables[t])){ret=!0;break}return ret},checkIfReadOnlyDB=function(e){ret=!1;for(let t=0;t<readOnlyDB.length;t++)if(e===readOnlyDB[t]){ret=!0;break}return ret},tableSelected=null,isTableSelected=function(e){tableSelected=e,null!=document.getElementById("displayButton")&&(document.getElementById("displayButton").disabled=!1),null!=document.getElementById("seeRelationsButton")&&(document.getElementById("seeRelationsButton").disabled=!1)},rowSelected=null,isRowSelected=function(e){if(null!=tableSelected&&!busy){let n=tableSelected.split(";")[0];var t=checkIfReadOnlyDB(n);t||(null!=document.getElementById("modifyButton")&&(document.getElementById("modifyButton").disabled=!1),null!=document.getElementById("deleteButton")&&(document.getElementById("deleteButton").disabled=!1)),null!=document.getElementById("showRelationsButton")&&(document.getElementById("showRelationsButton").disabled=!1),rowSelected!=e?(document.getElementById(e).style.backgroundColor="gray",null!=rowSelected&&(document.getElementById(rowSelected).style.backgroundColor=""),rowSelected=e):(document.getElementById(e).style.backgroundColor="",t||(null!=document.getElementById("modifyButton")&&(document.getElementById("modifyButton").disabled=!0),null!=document.getElementById("deleteButton")&&(document.getElementById("deleteButton").disabled=!0)),null!=document.getElementById("showRelationsButton")&&(document.getElementById("showRelationsButton").disabled=!0),rowSelected=null)}};function sleep(e){return new Promise(t=>setTimeout(t,e))}function containsForbiddenChar(e){ret=!1;for(let t=0;t<forbiddenChar.length;t++)if(e.indexOf(forbiddenChar[t])>-1){ret=!0;break}return ret}var app=angular.module("DBEditorAPF",["ngRoute"]);app.config(function(e){e.when("/",{templateUrl:"public/html/defaultDisplay.html"}).when("/db_management",{templateUrl:"public/html/db_management.html"}).when("/db_views",{templateUrl:"public/html/db_views.html"}).when("/dashboard",{templateUrl:"public/html/dashboard.html"}).when("/help",{templateUrl:"public/html/help.html"}).when("/login",{templateUrl:"public/html/login.html"}).when("/signup",{templateUrl:"public/html/signup.html"}).otherwise({redirectTo:"/"})}),app.factory("columnsDisplayFactory",function(){var e;return{setScope:function(t){e=t},getScope:function(){return e}}}),app.factory("buttonAreaFactory",function(){var e;return{setScope:function(t){e=t},getScope:function(){return e}}}),app.factory("postgresqlFactory",function(){var e;return{setScope:function(t){e=t},getScope:function(){return e}}}),app.factory("treeDatabaseAreaFactory",function(){var e;return{setScope:function(t){e=t},getScope:function(){return e}}}),app.factory("loginFactory",function(){var e;return{setScope:function(t){e=t},getScope:function(){return e}}}),app.controller("postgresqlController",function(e,t,n){n.setScope(e),e.getDBName=function(n){t({method:"GET",url:"/db/getDBName"}).then(function(t){e.successRequest=!0,e.dbArray=t,n&&n()},function(t){e.successRequest=!1,e.dbArray=t,n&&n()})},e.getTableName=function(n,l){t({method:"GET",url:"/db/getTableName?db="+n}).then(function(t){e.successRequest=!0,e.tableArray=t,l&&l()},function(t){e.successRequest=!1,e.tableArray=t,l&&l()})},e.getColumnName=function(n,l,o){t({method:"GET",url:"/db/getColumnName?db="+n+"&table="+l}).then(function(t){e.successRequest=!0,e.columnsArray=t,o&&o()},function(t){e.successRequest=!1,e.columnsArray=t,o&&o()})},e.getColumnConstraint=function(n,l,o){t({method:"GET",url:"/db/getColumnConstraint?db="+n+"&table="+l}).then(function(t){e.successRequest=!0,e.columnConstraint=t,o&&o()},function(t){e.successRequest=!1,e.columnConstraint=t,o&&o()})},e.getAllValues=function(n,l,o){t({method:"GET",url:"/db/getAllValues?db="+n+"&table="+l}).then(function(t){e.successRequest=!0,e.columnValues=t,o&&o()},function(t){e.successRequest=!1,e.columnValues=t,o&&o()})},e.getValuesOf=function(n,l,o,a){t({method:"GET",url:"/db/getValuesOf?db="+n+"&table="+l+"&att="+o}).then(function(t){e.successRequest=!0,e.valuesOf=t,a&&a()},function(t){e.successRequest=!1,e.valuesOf=t,a&&a()})},e.addRecord=function(n,l,o,a,s){t({method:"POST",url:"/db/addRecord?db="+n+"&table="+l+"&column_list="+JSON.stringify(o)+"&value_list="+JSON.stringify(a)}).then(function(t){e.successRequest=!0,e.addRequest=t,s&&s()},function(t){e.successRequest=!1,e.addRequest=t,s&&s()})},e.modifyRecord=function(n,l,o,a,s,u,d){t({method:"POST",url:"/db/modifyRecord?db="+n+"&table="+l+"&column_list="+JSON.stringify(o)+"&value_list="+JSON.stringify(a)+"&pkKey="+s+"&pkValue="+u}).then(function(t){e.successRequest=!0,e.modifyRequest=t,d&&d()},function(t){e.successRequest=!1,e.modifyRequest=t,d&&d()})},e.getPrimaryKey=function(n,l,o){t({method:"GET",url:"/db/getPrimaryKey?db="+n+"&table="+l}).then(function(t){e.successRequest=!0,e.primaryKey=t,o&&o()},function(t){e.successRequest=!1,e.primaryKey=t,o&&o()})},e.delRecord=function(n,l,o,a,s){t({method:"POST",url:"/db/delRecord?db="+n+"&table="+l+"&pkKey="+o+"&pkValue="+a}).then(function(t){e.successRequest=!0,e.deleteRequest=t,s&&s()},function(t){e.successRequest=!1,e.deleteRequest=t,s&&s()})},e.query=function(n,l,o,a,s,u){t({method:"GET",url:"/db/query?db="+n+"&table="+l+"&select="+o+"&condAtt="+a+"&condValue="+s}).then(function(t){e.successRequest=!0,e.queryRequest=t,u&&u()},function(t){e.successRequest=!1,e.queryRequest=t,u&&u()})},e.getDbMemory=function(n,l){t({method:"GET",url:"/db/getDbMemory?db="+n}).then(function(t){e.successRequest=!0,e.dbMemoryRequest=t,l&&l()},function(t){e.successRequest=!1,e.dbMemoryRequest=t,l&&l()})}}),app.controller("loginController",function(e,t,n,l,o){o.setScope(e);l.getScope();e.iden=function(){var t=document.getElementById("user").value,n=document.getElementById("pass").value,l=document.getElementById("check"),o=t+n;e.getMD5(o,function(){e.successRequest?e.check_login(e.md5.data,l):(console.log(e.md5),alert("Error on getMD5, check console logs."))})},e.clear_cook=function(){e.createCookie("identifiant","",-1),e.createCookie("date","",-1),window.location="#!/login"},e.verifco=function(){for(var t=document.getElementById("connexion"),n=document.getElementById("inscription"),l="date=",o="",a=decodeURIComponent(document.cookie).split(";"),s=0;s<a.length;s++){for(var u=a[s];" "==u.charAt(0);)u=u.substring(1);0==u.indexOf(l)&&(o=u.substring(l.length,u.length))}l="identifiant=";var d="";for(a=decodeURIComponent(document.cookie).split(";"),s=0;s<a.length;s++){for(u=a[s];" "==u.charAt(0);)u=u.substring(1);0==u.indexOf(l)&&(d=u.substring(l.length,u.length))}null==t&&null==n&&(""==o&&""==d?window.location="#!/login":e.createCookie("date","1",.041))},e.isLoggedOn=function(){for(var e="date=",t="",n=decodeURIComponent(document.cookie).split(";"),l=0;l<n.length;l++){for(var o=n[l];" "==o.charAt(0);)o=o.substring(1);0==o.indexOf(e)&&(t=o.substring(e.length,o.length))}e="identifiant=";var a="";for(n=decodeURIComponent(document.cookie).split(";"),l=0;l<n.length;l++){for(o=n[l];" "==o.charAt(0);)o=o.substring(1);0==o.indexOf(e)&&(a=o.substring(e.length,o.length))}return ret=!1,""==t&&""==a||(ret=!0),ret},e.check_login=function(t,n){e.getIdFromMD5(t,function(){e.successRequest?e.queryLogin.data.length>0?(n.checked&&e.createCookie("identifiant",t,31),window.location="/",e.createCookie("date","1",.041)):alert("Id or password incorrect"):(console.log(e.queryLogin),alert("Error on getIdFromMD5 request, check console logs."))})},e.readCookie=function(){cook="";for(var e=document.cookie.split(";"),t=0;t<e.length;t++){for(var n=e[t];" "==n.charAt(0);)n=n.substring(1);0==n.indexOf("date=")&&(cook=n.substring("date=".length,n.length))}alert(cook)},e.createCookie=function(e,t,n){if(n){var l=new Date;l.setTime(l.getTime()+24*n*60*60*1e3);var o="; expires="+l.toGMTString()}else o="";document.cookie=e+"="+t+o+"; path=/"},e.getIdFromMD5=function(n,l){t({method:"GET",url:"/login/getIdFromMD5?md5="+n}).then(function(t){e.successRequest=!0,e.queryLogin=t,l&&l()},function(t){e.successRequest=!1,e.queryLogin=t,l&&l()})},e.addLogin=function(n,l,o,a,s,u){t({method:"POST",url:"/login/addLogin?id="+n+"&md5="+l+"&mail="+o+"&md5NameMail="+a+"&validate="+s}).then(function(t){e.successRequest=!0,e.addLogin=t,u&&u()},function(t){e.successRequest=!1,e.addLogin=t,u&&u()})},e.getMD5=function(n,l){t({method:"GET",url:"/login/getTheMd5?up="+n}).then(function(t){e.successRequest=!0,e.md5=t,l&&l()},function(t){e.successRequest=!1,e.md5=t,l&&l()})},e.getIdFromMd5NameMail=function(n,l){t({method:"GET",url:"/login/getIdFromMd5NameMail?md5namemail="+n}).then(function(t){e.successRequest=!0,e.md5NameMail=t,l&&l()},function(t){e.successRequest=!1,e.md5NameMail=t,l&&l()})},e.reload=function(){n.reload()}}),app.controller("signupController",function(e,t,n,l){n.getScope();var o=l.getScope();e.normalizeStr=function(e){return e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(" ","+")},e.checkInfo=function(){var t=document.getElementById("user").value,n=document.getElementById("pass").value,l=document.getElementById("repass").value,a=document.getElementById("mail").value,s=document.getElementById("nom").value,u=document.getElementById("prenom").value,d=e.normalizeStr(s),r=e.normalizeStr(u),c=a.replace("@","%40"),i=[t,n,a,s,u],m="http://annuaire.sso.infra.ftgroup/persons?searchType=PERSON_COMPLEX&personCriteriaN="+d+"&personCriteriaP="+r+"&personCriteriaM="+c;n===l?e.areCorrectParam(i)?e.getAnnuaire(m,function(){e.successRequest?e.annuaire.data.includes("Aucun résultat trouvé. Relancer la requête sur des critères différents")?alert("You cannot register with the giving information, please try again or contact your administrator."):e.annuaire.data.includes("Profil de")?o.getMD5(s+u+a,function(){if(o.successRequest){var e=o.md5.data;o.getIdFromMd5NameMail(o.md5.data,function(){o.successRequest?""!=o.md5NameMail.data||null!=o.md5NameMail.data.length&&o.md5NameMail.data.length>0?alert("An account already exists for this person."):o.getMD5(t+n,function(){o.successRequest?o.addLogin(t,o.md5.data,a,e,!0,function(){o.successRequest?(alert("You have been registered."),window.location="#!/login"):(console.log(o.addLogin),alert("Error on addLogin request, check console logs."))}):(console.log(o.md5),alert("Error on getMD5 request, check console logs."))}):(console.log(o.md5NameMail),alert("Error on getIdFromMd5NameMail request, check console logs."))})}else console.log(o.md5),alert("Error on getMD5 request, check console logs.")}):console.log("Unhandle"):(console.log(e.annuaire),alert("Error on getAnnuaire request, check console logs."))}):alert("Invalid parameters, try again."):alert("The 2 passwords don't match.")},e.getAnnuaire=function(n,l){t({method:"GET",url:"/web/getAnnuaire?lien="+n}).then(function(t){e.successRequest=!0,e.annuaire=t,l&&l()},function(t){e.successRequest=!1,e.annuaire=t,l&&l()})},e.areCorrectParam=function(e){var t=!0;for(let n=0;n<e.length;n++)if(""==e[n]||containsForbiddenChar(e[n])){t=!1;break}return t}}),app.controller("treeDatabaseAreaController",function(e,t,n){e.databases=[];var l=t.getScope();n.setScope(e),e.ready=!1,e.displayNothing=!0,e.displayAdd=!1,e.displayModify=!1,e.displayRelations=!1,e.setDisplayTo=function(t){"nothing"===t?(e.displayNothing=!0,e.displayAdd=!1,e.displayModify=!1,e.displayRelations=!1):"add"===t?(e.displayNothing=!1,e.displayAdd=!0,e.displayModify=!1):"modify"===t?(e.displayNothing=!1,e.displayAdd=!1,e.displayModify=!0,e.displayRelations=!1):"relations"===t?(e.displayNothing=!1,e.displayAdd=!1,e.displayModify=!1,e.displayRelations=!0):console.log("Wrong type for setDisplayTo")},e.loadDB=function(){e.ready||l.getDBName(function(){if(l.successRequest){db=[];for(let e=0;e<l.dbArray.data.length;e++)exceptionDB.includes(l.dbArray.data[e].datname)||db.push(l.dbArray.data[e].datname);for(let t=0;t<db.length;t++)l.getTableName(db[t],function(){l.successRequest?(e.databases.push({name:db[t],table:l.tableArray.data}),t==db.length-1&&(e.ready=!0,$(function(){$("#treeDatabaseArea").jstree()}))):(console.log(l.tableArray),alert("Error on getTableName request, check console logs."))})}else console.log(l.dbArray),alert("Error on getDBName request, check console logs.")})}}),app.controller("columnsDisplayAreaController",function(e,t,n){t.setScope(e);var l=n.getScope();e.row_ids=[],e.elementIdToSet=[],e.checkIfIsReference=function(e){var t=!1;for(let n=0;n<l.columnConstraint.data.length;n++)if(e===l.columnConstraint.data[n].column_name){t=!0;break}return t},e.setIdForToolTips=function(t,n,l){let o=n+";"+JSON.stringify(t)+";"+l;return e.row_ids.push({id:o,column_name:n,value:l}),""},e.setToolTips=function(){for(let t=0;t<e.row_ids.length;t++)e.checkIfIsReference(e.row_ids[t].column_name)&&null!=document.getElementById(e.row_ids[t].id)&&(document.getElementById(e.row_ids[t].id).title=e.getInfoForFK(e.row_ids[t].column_name,e.row_ids[t].value));e.row_ids=[]},e.getInfoForFK=function(e,t){ret="";for(let n=0;n<l.valuesOfConstraint.length;n++)if(e===l.valuesOfConstraint[n].name){for(let e=0;e<l.valuesOfConstraint[n].values.length;e++)if(l.valuesOfConstraint[n].values[e].id===t){keys=Object.keys(l.valuesOfConstraint[n].values[e].records);for(let t=0;t<keys.length;t++)ret+=l.valuesOfConstraint[n].values[e].records[keys[t]]+" / ";ret=ret.substring(0,ret.length-3);break}break}return ret},e.clearTooltips=function(){listTD=document.getElementsByTagName("TD");for(let e=0;e<listTD.length;e++)listTD[e].title=""},e.setName=function(t,n,l){id=t+";"+JSON.stringify(n)+";"+l,e.elementIdToSet.push({id:id,column:t,set:!1,value:l})},e.setNameWithId=function(){if(null!=l.valuesOfConstraint)for(let t=0;t<l.valuesOfConstraint.length;t++)for(let n=0;n<e.elementIdToSet.length;n++)if(l.valuesOfConstraint[t].name==e.elementIdToSet[n].column&&!e.elementIdToSet[n].set)for(let o=0;o<l.valuesOfConstraint[t].values.length;o++)l.valuesOfConstraint[t].values[o].id==e.elementIdToSet[n].value&&null!=document.getElementById(e.elementIdToSet[n].id)&&(document.getElementById(e.elementIdToSet[n].id).innerHTML=l.valuesOfConstraint[t].values[o].name,e.elementIdToSet[n].set=!0)}}),app.controller("buttonAreaController",function(e,t,n,l,o){l.setScope(e);var a=n.getScope(),s=t.getScope(),u=o.getScope(),d=!1,r=tableSelected,c=rowSelected;null!=document.getElementById("displayButton")&&(document.getElementById("displayButton").disabled=!0),null!=document.getElementById("addButton")&&(document.getElementById("addButton").disabled=!0),null!=document.getElementById("modifyButton")&&(document.getElementById("modifyButton").disabled=!0),null!=document.getElementById("deleteButton")&&(document.getElementById("deleteButton").disabled=!0),null!=document.getElementById("clearButton")&&(document.getElementById("clearButton").disabled=!1),null!=document.getElementById("showRelationsButton")&&(document.getElementById("showRelationsButton").disabled=!0),e.display=function(e,n){busy=!1,r=tableSelected,c=rowSelected;var l=!0,o=t.getScope();if(u.setDisplayTo("nothing"),null!=c&&(document.getElementById(c).style.backgroundColor=""),rowSelected=null,o.row_ids=[],o.elementIdToSet=[],o.clearTooltips(),null!=r){let e=r.split(";")[0];d=checkIfReadOnlyDB(e)}if(document.getElementById("columnsDisplayArea").style.display="block",d?(null!=document.getElementById("addButton")&&(document.getElementById("addButton").disabled=!0),null!=document.getElementById("modifyButton")&&(document.getElementById("modifyButton").disabled=!0),null!=document.getElementById("deleteButton")&&(document.getElementById("deleteButton").disabled=!0),null!=document.getElementById("showRelationsButton")&&(document.getElementById("showRelationsButton").disabled=!0)):(null!=document.getElementById("modifyButton")&&(document.getElementById("modifyButton").disabled=!0),null!=document.getElementById("deleteButton")&&(document.getElementById("deleteButton").disabled=!0),null!=document.getElementById("showRelationsButton")&&(document.getElementById("showRelationsButton").disabled=!0)),null!=r){let t=r.split(";"),s=t[0],u=t[1];d||(document.getElementById("addButton").disabled=!1),a.getColumnName(s,u,function(){a.successRequest?(o.columns=a.columnsArray.data,a.getAllValues(s,u,function(){if(a.successRequest){o.tuples=[];for(let s=0;s<a.columnValues.data.length;s++){t=[];for(let u=0;u<o.columns.length;u++){let d=a.columnValues.data[s][o.columns[u].column_name];for(let e=0;e<displayName.length;e++)if(null!=a.columnValues.data[s][displayName[e]]){d=a.columnValues.data[s][displayName[e]];break}l=null==e||null==n||o.columns[u].column_name==e&&a.columnValues.data[s][o.columns[u].column_name]==n,t.push(a.columnValues.data[s][o.columns[u].column_name])}l&&o.tuples.push({column_names:o.columns,values:t})}}else console.log(a.columnValues),alert("Error on getAllValues request, check console logs.")}),a.getColumnConstraint(s,u,function(){if(a.successRequest){a.valuesOfConstraint=[];for(let e=0;e<a.columnConstraint.data.length;e++){let t=[];a.getValuesOf(s,a.columnConstraint.data[e].foreign_table_name,"*",function(){if(a.successRequest){for(let n=0;n<a.valuesOf.data.length;n++){let l=null,o=null;for(let e=0;e<displayName.length;e++)if(null!=a.valuesOf.data[n][displayName[e]]){l=a.valuesOf.data[n][displayName[e]],o=displayName[e];break}t.push({id:a.valuesOf.data[n][a.columnConstraint.data[e].foreign_column_name],name:l,table:a.columnConstraint.data[e].foreign_table_name,records:a.valuesOf.data[n]})}a.valuesOfConstraint.push({name:a.columnConstraint.data[e].column_name,values:t}),o.setToolTips()}else console.log(a.valuesOf),alert("Error on getValuesOf request, check console logs.")})}o.setNameWithId()}else console.log(a.columnConstraint),alert("Error on getColumnConstraint request, check console logs.")})):(console.log(a.columnsArray),alert("Error on getColumnName request, check console logs."))})}},e.add=function(){d||(null!=document.getElementById("addButton")&&(document.getElementById("addButton").disabled=!0),null!=document.getElementById("modifyButton")&&(document.getElementById("modifyButton").disabled=!0),null!=document.getElementById("deleteButton")&&(document.getElementById("deleteButton").disabled=!0),null!=document.getElementById("showRelationsButton")&&(document.getElementById("showRelationsButton").disabled=!0),u.setDisplayTo("add"),busy=!0)},e.modify=function(){d||(null!=document.getElementById("addButton")&&(document.getElementById("addButton").disabled=!0),null!=document.getElementById("modifyButton")&&(document.getElementById("modifyButton").disabled=!0),null!=document.getElementById("deleteButton")&&(document.getElementById("deleteButton").disabled=!0),null!=document.getElementById("showRelationsButton")&&(document.getElementById("showRelationsButton").disabled=!0),u.setDisplayTo("modify"),busy=!0)},e.delete=function(){if(c=rowSelected,r=tableSelected,confirm("Do you want to delete this record ?")&&null!=r){let t=r.split(";"),n=t[0],l=t[1];a.getPrimaryKey(n,l,function(){if(a.successRequest){for(let e=0;e<s.columns.length;e++)if(a.primaryKey.data[0].attname===s.columns[e].column_name){var t=JSON.parse(c)[e];break}a.delRecord(n,l,a.primaryKey.data[0].attname,t,function(){a.successRequest?(e.display(),rowSelected=null):(console.log(a.deleteRequest),alert("Error on delRecord request, check console logs."))})}else console.log(a.primaryKey),alert("Error on getPrimaryKey request, check console logs.")})}},e.clear=function(){null!=document.getElementById("columnsDisplayArea")&&(document.getElementById("columnsDisplayArea").style.display="none"),d||(null!=document.getElementById("addButton")&&(document.getElementById("addButton").disabled=!0),null!=document.getElementById("modifyButton")&&(document.getElementById("modifyButton").disabled=!0),null!=document.getElementById("deleteButton")&&(document.getElementById("deleteButton").disabled=!0),null!=u&&u.setDisplayTo("nothing")),null!=rowSelected&&null!=document.getElementById(rowSelected)&&(document.getElementById(rowSelected).style.backgroundColor=""),rowSelected=null,busy=!1,u.setDisplayTo("nothing")},e.showRelations=function(){d||(null!=document.getElementById("addButton")&&(document.getElementById("addButton").disabled=!0),null!=document.getElementById("modifyButton")&&(document.getElementById("modifyButton").disabled=!0),null!=document.getElementById("deleteButton")&&(document.getElementById("deleteButton").disabled=!0)),busy=!0,null!=document.getElementById("showRelationsButton")&&(document.getElementById("showRelationsButton").disabled=!0),u.setDisplayTo("relations")}}),app.controller("addRowAreaController",function(e,t,n,l,o){var a=t.getScope(),s=n.getScope(),u=l.getScope(),d=o.getScope(),r=tableSelected,c=rowSelected;a.row_ids=[],e.references=[],e.attributes=[];for(let t=0;t<a.columns.length;t++)exceptionColumns.includes(a.columns[t].column_name)||e.attributes.push(a.columns[t]);if(null!=r)for(let t=0;t<e.attributes.length;t++){let n=[];for(let l=0;l<s.valuesOfConstraint.length;l++)if(e.attributes[t].column_name==s.valuesOfConstraint[l].name){for(let e=0;e<s.valuesOfConstraint[l].values.length;e++)null!=s.valuesOfConstraint[l].values[e].name?theName=s.valuesOfConstraint[l].values[e].name:theName=s.valuesOfConstraint[l].values[e].id,n.push({id:s.valuesOfConstraint[l].values[e].id,name:theName});break}let l={};l[e.attributes[t].column_name]=n,e.references.push(l)}e.checkIfIsReference=function(e){var t=!1;if(null!=r)for(let n=0;n<s.columnConstraint.data.length;n++)if(e===s.columnConstraint.data[n].column_name){t=!0;break}return t},e.saveRecord=function(){var t=!1;if(confirm("Are you sure you want to save this record ?")){if(null!=r){let n=r.split(";"),l=n[0],o=n[1];columnList=[];for(let t=0;t<e.attributes.length;t++)columnList.push(e.attributes[t].column_name);valueList=[];for(let n=0;n<columnList.length;n++){let l=document.getElementById(columnList[n]);if("INPUT"===l.nodeName)if(null==l.value)valueList.push("");else if(e.attributes[n].data_type.toLowerCase().includes("int"))valueList.push(parseInt(l.value));else{if(containsForbiddenChar(l.value)){t=!0;break}t=!1,valueList.push(l.value)}else if("SELECT"===l.nodeName)if(null==l.selectedIndex||null==l.options[l.selectedIndex])valueList.push("");else if(e.attributes[n].data_type.toLowerCase().includes("int"))valueList.push(parseInt(l.options[l.selectedIndex].value));else{if(containsForbiddenChar(l.options[l.selectedIndex].value)){t=!0;break}t=!1,valueList.push(l.options[l.selectedIndex].value)}}t||s.addRecord(l,o,columnList,valueList,function(){s.successRequest?(u.display(),null!=c&&(null!=document.getElementById("modifyButton")&&(document.getElementById("modifyButton").disabled=!0),null!=document.getElementById("deleteButton")&&(document.getElementById("deleteButton").disabled=!0),null!=c&&(document.getElementById(c).style.backgroundColor=""),null!=c&&(document.getElementById(c).style.backgroundColor=""),rowSelected=null)):(console.log(s.addRequest),alert("Error on addRecord request, check console logs."))})}t?alert("You cannot add elements with forbidden characters"):(d.setDisplayTo("nothing"),document.getElementById("addButton").disabled=!1,document.getElementById("modifyButton").disabled=!1,busy=!1)}},e.cancelRecord=function(){confirm("Are you sure you want to cancel ?")&&(d.setDisplayTo("nothing"),document.getElementById("addButton").disabled=!1,document.getElementById("modifyButton").disabled=!0,null!=c&&(document.getElementById(c).style.backgroundColor=""),null!=c&&(document.getElementById(c).style.backgroundColor=""),rowSelected=null,busy=!1)},e.setIdForToolTips=function(e,t){ret="";let n="a"+t+e;a.row_ids.push({id:n,column_name:t,value:e});for(let e=0;e<a.row_ids.length;e++)a.checkIfIsReference(a.row_ids[e].column_name)&&null!=document.getElementById(a.row_ids[e].id)&&(ret=a.getInfoForFK(a.row_ids[e].column_name,a.row_ids[e].value));return ret}}),app.controller("modifyRowAreaController",function(e,t,n,l,o){var a=t.getScope(),s=n.getScope(),u=l.getScope(),d=o.getScope(),r=rowSelected,c=tableSelected;a.row_ids=[],e.attributes=[];let i=JSON.parse(r);for(let t=0;t<a.columns.length;t++)exceptionColumns.includes(a.columns[t].column_name)||e.attributes.push({name:a.columns[t],value:i[t]});if(e.references=[],null!=c)for(let t=0;t<e.attributes.length;t++){let n=[];for(let l=0;l<s.valuesOfConstraint.length;l++)if(e.attributes[t].name.column_name==s.valuesOfConstraint[l].name){for(let e=0;e<s.valuesOfConstraint[l].values.length;e++)null!=s.valuesOfConstraint[l].values[e].name?theName=s.valuesOfConstraint[l].values[e].name:theName=s.valuesOfConstraint[l].values[e].id,n.push({id:s.valuesOfConstraint[l].values[e].id,name:theName});break}let l={};l[e.attributes[t].name.column_name]=n,e.references.push(l)}e.saveRecord=function(){var t=!1;if(confirm("Are you sure you want to save this record ?")&&null!=c){let n=c.split(";"),l=n[0],o=n[1];columnList=[];for(let t=0;t<e.attributes.length;t++)columnList.push(e.attributes[t].name.column_name);valueList=[];for(let n=0;n<columnList.length;n++){let l=document.getElementById(columnList[n]);if("INPUT"===l.nodeName)if(null==l.value)valueList.push("");else if(e.attributes[n].name.data_type.toLowerCase().includes("int"))valueList.push(parseInt(l.value));else{if(containsForbiddenChar(l.value)){t=!0;break}t=!1,valueList.push(l.value)}else if("SELECT"===l.nodeName)if(null==l.selectedIndex||null==l.options[l.selectedIndex])valueList.push("");else if(e.attributes[n].name.data_type.toLowerCase().includes("int"))valueList.push(parseInt(l.options[l.selectedIndex].value));else{if(containsForbiddenChar(l.options[l.selectedIndex].value)){t=!0;break}t=!1,valueList.push(l.options[l.selectedIndex].value)}}t||s.getPrimaryKey(l,o,function(){if(s.successRequest){for(let t=0;a.columns.length;t++)if(s.primaryKey.data[0].attname===a.columns[t].column_name){var e=JSON.parse(r)[t];break}s.modifyRecord(l,o,columnList,valueList,s.primaryKey.data[0].attname,e,function(){s.successRequest?(u.display(),document.getElementById("modifyButton").disabled=!0,null!=rowSelected&&(document.getElementById(rowSelected).style.backgroundColor=""),null!=r&&(document.getElementById(r).style.backgroundColor=""),rowSelected=null):(console.log(s.modifyRequest),alert("Error on getPrimaryKey request, check console logs."))})}else console.log(s.primaryKey),alert("Error on getPrimaryKey request, check console logs.")}),t?alert("You cannot modify elements with forbidden characters"):(d.setDisplayTo("nothing"),document.getElementById("addButton").disabled=!1,document.getElementById("modifyButton").disabled=!1,busy=!1)}},e.cancelRecord=function(){confirm("Are you sure you want to cancel ?")&&(d.setDisplayTo("nothing"),document.getElementById("addButton").disabled=!1,document.getElementById("modifyButton").disabled=!0,null!=rowSelected&&(document.getElementById(rowSelected).style.backgroundColor=""),null!=r&&(document.getElementById(r).style.backgroundColor=""),rowSelected=null,busy=!1)},e.checkIfIsReference=function(e){var t=!1;if(null!=c)for(let n=0;n<s.columnConstraint.data.length;n++)if(e===s.columnConstraint.data[n].column_name){t=!0;break}return t},e.setIdForToolTips=function(e,t){ret="";let n="m"+t+e;a.row_ids.push({id:n,column_name:t,value:e});for(let e=0;e<a.row_ids.length;e++)a.checkIfIsReference(a.row_ids[e].column_name)&&null!=document.getElementById(a.row_ids[e].id)&&(ret=a.getInfoForFK(a.row_ids[e].column_name,a.row_ids[e].value));return ret}}),app.controller("relationsAreaController",function(e,t,n,l){var o=t.getScope(),a=n.getScope(),s=l.getScope();e.relationsData=[],e.ready=!1,e.displayRel=function(){if(currentTableSelected=tableSelected,currentRowSelected=rowSelected,e.relationsData=[],e.ready=!1,null!=currentTableSelected){let t=currentTableSelected.split(";"),n=t[0],l=t[1];o.getPrimaryKey(n,l,function(){if(o.successRequest){var t=o.primaryKey.data[0].attname;for(let e=0;e<a.columns.length;e++)if(t==a.columns[e].column_name){var u=JSON.parse(currentRowSelected)[e];break}for(let a=0;a<s.databases.length;a++)if(s.databases[a].name==n){for(let d=0;d<s.databases[a].table.length;d++)s.databases[a].table[d].table_name!=l&&o.getColumnConstraint(n,s.databases[a].table[d].table_name,function(){if(o.successRequest)for(let r=0;r<o.columnConstraint.data.length;r++){if(o.columnConstraint.data[r].foreign_table_name==l&&o.columnConstraint.data[r].foreign_column_name==t){col=o.columnConstraint.data[r].column_name,o.getPrimaryKey(n,o.columnConstraint.data[r].table_name,function(){o.successRequest&&o.query(n,s.databases[a].table[d].table_name,"*",col,u,function(){if(o.successRequest){let t=o.primaryKey.data[0].attname;if(o.queryRequest.data.length>0)for(let e=0;e<displayName.length;e++)if(null!=o.queryRequest.data[0][displayName[e]]){t=displayName[e];break}e.relationsData.push({table_name:s.databases[a].table[d].table_name,values:o.queryRequest.data,id:o.primaryKey.data[0].attname,name:t})}else console.log(o.queryRequest),alert("Error on query request, check console logs.")})});break}break}else console.log(o.columnConstraint),alert("Error on getColumnConstraint request, check console logs.")});break}e.ready=!0}else console.log(o.primaryKey),alert("Error on getPrimaryKey request, check console logs.")})}},e.clear=function(){busy=!1,e.relationsData=[],e.ready=!1,s.setDisplayTo("nothing"),null!=document.getElementById("showRelationsButton")&&(document.getElementById("showRelationsButton").disabled=!1)}}),app.controller("chartDisplayController",function(e,t,n){var l,o=t.getScope();e.readyDB=!1,e.readyValues=!1,e.readyDBChart=!1,e.readyMemory=!1,e.readyChartSondeTenant=!1,e.dbColors=[],e.databases=[],e.chartsSondeTenant=[],e.relTenantIdName=[],e.getRGBA=function(){ret=[],temp="rgba(";for(let e=0;e<3;e++)temp+=Math.floor(256*Math.random())+", ";return ret.push(temp+"0.2)"),ret.push(temp+"1)"),ret},e.splitTheTableName=function(e){return e.split("_")[0]},e.wait=async function(){await sleep(waitFor)},e.getIdTenantFromName=function(t){var n;for(let l=0;l<e.relTenantIdName.length;l++)if(e.relTenantIdName[l].name==t){n=e.relTenantIdName[l].id;break}return n},e.loadDB=function(){e.readyDB||o.getDBName(function(){if(o.successRequest){db=[];for(let e=0;e<o.dbArray.data.length;e++)exceptionDB.includes(o.dbArray.data[e].datname)||db.push(o.dbArray.data[e].datname);for(let t=0;t<db.length;t++)o.getTableName(db[t],function(){if(o.successRequest){if(e.databases.push({name:db[t],table:o.tableArray.data}),t==db.length-1){for(let t=0;t<e.databases.length;t++)for(let n=0;n<e.databases[t].table.length;n++)e.databases[t].table[n].values=[];e.readyDB=!0,e.loadTableValues(),e.loadChartNbTablesInDB()}}else console.log(o.tableArray),alert("Error on getTableName request, check console logs.")})}else console.log(o.dbArray),alert("Error on getDBName request, check console logs.")})},e.loadTableValues=function(){if(!e.readyValues&&e.readyDB)for(let t=0;t<e.databases.length;t++)for(let n=0;n<e.databases[t].table.length;n++)o.getAllValues(e.databases[t].name,e.databases[t].table[n].table_name,function(){e.successRequest?(e.databases[t].table[n].values=o.columnValues.data,t==e.databases.length-1&&n==e.databases[t].table.length-1&&(e.readyValues=!0,e.loadSondeTenant(),e.loadDbMemory())):(console.log(o.columnValues),alert("Error on getAllValues request, check console logs."))})},e.loadSondeTenant=function(){var t,n,l,o,a,s=[],u=[],d=[],r=[];for(let t=0;t<e.databases.length;t++)if("sonde"==e.databases[t].name){for(let n=0;n<e.databases[t].table.length;n++)if("tenant_table"==e.databases[t].table[n].table_name)for(let l=0;l<e.databases[t].table[n].values.length;l++)s.push(e.databases[t].table[n].values[l].uuid),u.push(e.databases[t].table[n].values[l].tenant_name),e.relTenantIdName.push({id:e.databases[t].table[n].values[l].uuid,name:e.databases[t].table[n].values[l].tenant_name});else"sg_table"!=e.databases[t].table[n].table_name&&"subnet_table"!=e.databases[t].table[n].table_name&&"ecs_table"!=e.databases[t].table[n].table_name||r.push(e.databases[t].table[n]);break}var c="";for(let u=0;u<r.length;u++){t=[],n=[],l=e.getRGBA(),o=[];for(let e=0;e<s.length;e++){a=0;for(let t=0;t<r[u].values.length;t++)r[u].values[t].tenant_uuid==s[e]&&a++;o.push(a),t.push(l[0]),n.push(l[1])}"sg_table"==r[u].table_name?c="Security Group":"subnet_table"==r[u].table_name?c="Subnet":"ecs_table"==r[u].table_name&&(c="Elastic Cloud Server"),d.push({label:c,data:o,backgroundColor:t,borderColor:n,borderWidth:1})}for(let t=0;t<d.length;t++)e.chartsSondeTenant.push({labels:u,datasets:d[t]});e.readyChartSondeTenant=!0},e.loadDbMemory=function(){if(e.readyDB)for(let t=0;t<e.databases.length;t++)o.getDbMemory(e.databases[t].name,function(){o.successRequest?(e.databases[t].size=(parseInt(o.dbMemoryRequest.data[0].pg_database_size)/1e6).toFixed(2),t==e.databases.length-1&&(e.readyMemory=!0,e.loadChartDbMemory())):(console.log(o.dbMemoryRequest),alert("Error on getDbMemory request, check console logs."))})},e.loadChartNbTablesInDB=function(){var t=$("#nbTablesInDB"),n=[],l=[],o=[],a=[];for(let t=0;t<e.databases.length;t++)n.push(e.databases[t].name),l.push(e.databases[t].table.length),rgba=e.getRGBA(),o.push(rgba[0]),a.push(rgba[1]),e.dbColors.push({db_name:e.databases[t].name,color:rgba});new Chart(t,{type:"pie",data:{labels:n,datasets:[{label:"Number of table(s)",data:l,backgroundColor:o,borderColor:a,borderWidth:1}]}});e.readyDBChart=!0},e.loadChartNbTuplesInTable=function(t){canvas=document.getElementById("nbTuplesInTable"),canvas.id=canvas.id+t;var n=document.getElementById("nbTuplesInTable"+t),l=[],o=[],a=[],s=[],u=e.getRGBA();for(let n=0;n<e.databases.length;n++)for(let d=0;d<e.databases[n].table.length;d++)if(e.databases[n].name==t&&!isInExceptionTables(e.databases[n].table[d].table_name)){for(let t=0;t<e.dbColors.length;t++)e.databases[n].name==e.dbColors[t].db_name&&(u=e.dbColors[t].color);l.push(e.splitTheTableName(e.databases[n].table[d].table_name)),o.push(e.databases[n].table[d].values.length),a.push(u[0]),s.push(u[1])}new Chart(n,{type:"bar",data:{labels:l,datasets:[{label:"Number of record(s) in "+t,data:o,backgroundColor:a,borderColor:s,borderWidth:1}]},options:{scales:{yAxes:[{ticks:{beginAtZero:!0}}]}}})},e.loadChartDbMemory=function(){var t=$("#dbMemory"),n=[],l=[],o=[],a=[],s=e.getRGBA();for(let t=0;t<e.databases.length;t++){for(let n=0;n<e.dbColors.length;n++)e.databases[t].name==e.dbColors[n].db_name&&(s=e.dbColors[n].color);n.push(e.databases[t].name),l.push(e.databases[t].size),o.push(s[0]),a.push(s[1])}new Chart(t,{type:"pie",data:{labels:n,datasets:[{label:"Memory of database(s) in Mb",data:l,backgroundColor:o,borderColor:a,borderWidth:1}]}})},e.loadChartSondeTenant=function(t){canvas=document.getElementById("sondeTenant"),canvas.id=canvas.id+t.datasets.label;var o=document.getElementById("sondeTenant"+t.datasets.label),a=new Chart(o,{type:"bar",data:{labels:t.labels,datasets:[t.datasets]},options:{scales:{yAxes:[{ticks:{beginAtZero:!0}}]}}});canvas.onclick=function(t){var o=a.getElementsAtEvent(t);if(o.length>0){let t;window.location="#!/db_management",e.wait(),null==(l=n.getScope())&&(e.wait(),l=n.getScope()),"Elastic Cloud Server"==o[0]._model.datasetLabel?t="ecs_table":"Security Group"==o[0]._model.datasetLabel?t="sg_table":"Subnet"==o[0]._model.datasetLabel&&(t="subnet_table"),tableSelected="sonde;"+t,l.display("tenant_uuid",e.getIdTenantFromName(o[0]._model.label))}}}});
