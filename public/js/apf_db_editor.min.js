var exceptionDB=['postgres','template0','template1'],exceptionColumns=['uuid'],readOnlyDB=['sonde'],displayName=['name','tenant_name','sg_name','subnet_name','ecs_name','kp_name','vpc_name','uuid'],busy=!1,exceptionTables=['map'],waitFor=1,forbiddenChar=['#','%','&','+','[',']','{','}','\'','"','\\'],isInExceptionTables=function(e){ret=!1;for(let t=0;t<exceptionTables.length;t++)if(e.startsWith(exceptionTables[t])){ret=!0;break}return ret},checkIfReadOnlyDB=function(e){ret=!1;for(let t=0;t<readOnlyDB.length;t++)if(e===readOnlyDB[t]){ret=!0;break}return ret},tableSelected=null,isTableSelected=function(e){tableSelected=e,null!=document.getElementById('displayButton')&&(document.getElementById('displayButton').disabled=!1),null!=document.getElementById('seeRelationsButton')&&(document.getElementById('seeRelationsButton').disabled=!1)},rowSelected=null,isRowSelected=function(e){if(null!=tableSelected&&!busy){let a=tableSelected.split(';'),n=a[0];var t=checkIfReadOnlyDB(n);t||(null!=document.getElementById('modifyButton')&&(document.getElementById('modifyButton').disabled=!1),null!=document.getElementById('deleteButton')&&(document.getElementById('deleteButton').disabled=!1)),null!=document.getElementById('showRelationsButton')&&(document.getElementById('showRelationsButton').disabled=!1),rowSelected==e?(document.getElementById(e).style.backgroundColor='',!t&&(null!=document.getElementById('modifyButton')&&(document.getElementById('modifyButton').disabled=!0),null!=document.getElementById('deleteButton')&&(document.getElementById('deleteButton').disabled=!0)),null!=document.getElementById('showRelationsButton')&&(document.getElementById('showRelationsButton').disabled=!0),rowSelected=null):(document.getElementById(e).style.backgroundColor='gray',null!=rowSelected&&(document.getElementById(rowSelected).style.backgroundColor=''),rowSelected=e)}};function sleep(e){return new Promise(t=>setTimeout(t,e))}function containsForbiddenChar(e){ret=!1;for(let t=0;t<forbiddenChar.length;t++)if(-1<e.indexOf(forbiddenChar[t])){ret=!0;break}return ret}var app=angular.module('DBEditorAPF',['ngRoute']);app.config(function(e){e.when('/',{templateUrl:'public/html/defaultDisplay.html'}).when('/db_management',{templateUrl:'public/html/db_management.html'}).when('/db_views',{templateUrl:'public/html/db_views.html'}).when('/dashboard',{templateUrl:'public/html/dashboard.html'}).when('/help',{templateUrl:'public/html/help.html'}).when('/login',{templateUrl:'public/html/login.html'}).when('/signup',{templateUrl:'public/html/signup.html'}).otherwise({redirectTo:'/'})}),app.factory('columnsDisplayFactory',function(){var e;return{setScope:function(t){e=t},getScope:function(){return e}}}),app.factory('buttonAreaFactory',function(){var e;return{setScope:function(t){e=t},getScope:function(){return e}}}),app.factory('postgresqlFactory',function(){var e;return{setScope:function(t){e=t},getScope:function(){return e}}}),app.factory('treeDatabaseAreaFactory',function(){var e;return{setScope:function(t){e=t},getScope:function(){return e}}}),app.factory('loginFactory',function(){var e;return{setScope:function(t){e=t},getScope:function(){return e}}}),app.controller('postgresqlController',function(e,t,a){a.setScope(e),e.getDBName=function(n){t({method:'GET',url:'/db/getDBName'}).then(function(d){e.successRequest=!0,e.dbArray=d,n&&n()},function(d){e.successRequest=!1,e.dbArray=d,n&&n()})},e.getTableName=function(n,s){t({method:'GET',url:'/db/getTableName?db='+n}).then(function(o){e.successRequest=!0,e.tableArray=o,s&&s()},function(o){e.successRequest=!1,e.tableArray=o,s&&s()})},e.getColumnName=function(n,s,d){t({method:'GET',url:'/db/getColumnName?db='+n+'&table='+s}).then(function(u){e.successRequest=!0,e.columnsArray=u,d&&d()},function(u){e.successRequest=!1,e.columnsArray=u,d&&d()})},e.getColumnConstraint=function(n,s,d){t({method:'GET',url:'/db/getColumnConstraint?db='+n+'&table='+s}).then(function(u){e.successRequest=!0,e.columnConstraint=u,d&&d()},function(u){e.successRequest=!1,e.columnConstraint=u,d&&d()})},e.getAllValues=function(n,s,d){t({method:'GET',url:'/db/getAllValues?db='+n+'&table='+s}).then(function(u){e.successRequest=!0,e.columnValues=u,d&&d()},function(u){e.successRequest=!1,e.columnValues=u,d&&d()})},e.getValuesOf=function(n,s,d,o){t({method:'GET',url:'/db/getValuesOf?db='+n+'&table='+s+'&att='+d}).then(function(r){e.successRequest=!0,e.valuesOf=r,o&&o()},function(r){e.successRequest=!1,e.valuesOf=r,o&&o()})},e.addRecord=function(n,s,d,o,u){t({method:'POST',url:'/db/addRecord?db='+n+'&table='+s+'&column_list='+JSON.stringify(d)+'&value_list='+JSON.stringify(o)}).then(function(g){e.successRequest=!0,e.addRequest=g,u&&u()},function(g){e.successRequest=!1,e.addRequest=g,u&&u()})},e.modifyRecord=function(n,s,d,o,u,r,g){t({method:'POST',url:'/db/modifyRecord?db='+n+'&table='+s+'&column_list='+JSON.stringify(d)+'&value_list='+JSON.stringify(o)+'&pkKey='+u+'&pkValue='+r}).then(function(f){e.successRequest=!0,e.modifyRequest=f,g&&g()},function(f){e.successRequest=!1,e.modifyRequest=f,g&&g()})},e.getPrimaryKey=function(n,s,d){t({method:'GET',url:'/db/getPrimaryKey?db='+n+'&table='+s}).then(function(u){e.successRequest=!0,e.primaryKey=u,d&&d()},function(u){e.successRequest=!1,e.primaryKey=u,d&&d()})},e.delRecord=function(n,s,d,o,u){t({method:'POST',url:'/db/delRecord?db='+n+'&table='+s+'&pkKey='+d+'&pkValue='+o}).then(function(g){e.successRequest=!0,e.deleteRequest=g,u&&u()},function(g){e.successRequest=!1,e.deleteRequest=g,u&&u()})},e.query=function(n,s,d,o,u,r){t({method:'GET',url:'/db/query?db='+n+'&table='+s+'&select='+d+'&condAtt='+o+'&condValue='+u}).then(function(b){e.successRequest=!0,e.queryRequest=b,r&&r()},function(b){e.successRequest=!1,e.queryRequest=b,r&&r()})},e.getDbMemory=function(n,s){t({method:'GET',url:'/db/getDbMemory?db='+n}).then(function(o){e.successRequest=!0,e.dbMemoryRequest=o,s&&s()},function(o){e.successRequest=!1,e.dbMemoryRequest=o,s&&s()})}}),app.controller('chartDisplayController',function(e,t,a){var n=t.getScope(),s;e.readyDB=!1,e.readyValues=!1,e.readyDBChart=!1,e.readyMemory=!1,e.readyChartSondeTenant=!1,e.dbColors=[],e.databases=[],e.chartsSondeTenant=[],e.relTenantIdName=[],e.getRGBA=function(){ret=[],temp='rgba(';for(let d=0;3>d;d++)temp+=Math.floor(256*Math.random())+', ';return ret.push(temp+'0.2)'),ret.push(temp+'1)'),ret},e.splitTheTableName=function(d){return d.split('_')[0]},e.wait=async function(){await sleep(waitFor)},e.getIdTenantFromName=function(d){var o;for(let u=0;u<e.relTenantIdName.length;u++)if(e.relTenantIdName[u].name==d){o=e.relTenantIdName[u].id;break}return o},e.loadDB=function(){e.readyDB||n.getDBName(function(){if(n.successRequest){db=[];for(let d=0;d<n.dbArray.data.length;d++)exceptionDB.includes(n.dbArray.data[d].datname)||db.push(n.dbArray.data[d].datname);for(let d=0;d<db.length;d++)n.getTableName(db[d],function(){if(!n.successRequest)console.log(n.tableArray),alert('Error on getTableName request, check console logs.');else if(e.databases.push({name:db[d],table:n.tableArray.data}),d==db.length-1){for(let o=0;o<e.databases.length;o++)for(let u=0;u<e.databases[o].table.length;u++)e.databases[o].table[u].values=[];e.readyDB=!0,e.loadTableValues(),e.loadChartNbTablesInDB()}})}else console.log(n.dbArray),alert('Error on getDBName request, check console logs.')})},e.loadTableValues=function(){if(!e.readyValues&&e.readyDB)for(let d=0;d<e.databases.length;d++)for(let o=0;o<e.databases[d].table.length;o++)n.getAllValues(e.databases[d].name,e.databases[d].table[o].table_name,function(){e.successRequest?(e.databases[d].table[o].values=n.columnValues.data,d==e.databases.length-1&&o==e.databases[d].table.length-1&&(e.readyValues=!0,e.loadSondeTenant(),e.loadDbMemory())):(console.log(n.columnValues),alert('Error on getAllValues request, check console logs.'))})},e.loadSondeTenant=function(){var d=[],o=[],u=[],r=[];for(let I=0;I<e.databases.length;I++)if('sonde'==e.databases[I].name){for(let E=0;E<e.databases[I].table.length;E++)if('tenant_table'==e.databases[I].table[E].table_name)for(let R=0;R<e.databases[I].table[E].values.length;R++)d.push(e.databases[I].table[E].values[R].uuid),o.push(e.databases[I].table[E].values[R].tenant_name),e.relTenantIdName.push({id:e.databases[I].table[E].values[R].uuid,name:e.databases[I].table[E].values[R].tenant_name});else('sg_table'==e.databases[I].table[E].table_name||'subnet_table'==e.databases[I].table[E].table_name||'ecs_table'==e.databases[I].table[E].table_name)&&r.push(e.databases[I].table[E]);break}var g,b,f,h,p,B='';for(let I=0;I<r.length;I++){g=[],b=[],f=e.getRGBA(),h=[];for(let E=0;E<d.length;E++){p=0;for(let R=0;R<r[I].values.length;R++)r[I].values[R].tenant_uuid==d[E]&&p++;h.push(p),g.push(f[0]),b.push(f[1])}'sg_table'==r[I].table_name?B='Security Group':'subnet_table'==r[I].table_name?B='Subnet':'ecs_table'==r[I].table_name&&(B='Elastic Cloud Server'),u.push({label:B,data:h,backgroundColor:g,borderColor:b,borderWidth:1})}for(let I=0;I<u.length;I++)e.chartsSondeTenant.push({labels:o,datasets:u[I]});e.readyChartSondeTenant=!0},e.loadDbMemory=function(){if(e.readyDB)for(let d=0;d<e.databases.length;d++)n.getDbMemory(e.databases[d].name,function(){n.successRequest?(e.databases[d].size=(parseInt(n.dbMemoryRequest.data[0].pg_database_size)/1e6).toFixed(2),d==e.databases.length-1&&(e.readyMemory=!0,e.loadChartDbMemory())):(console.log(n.dbMemoryRequest),alert('Error on getDbMemory request, check console logs.'))})},e.loadChartNbTablesInDB=function(){var d=$('#nbTablesInDB'),o=[],u=[],r=[],g=[];for(let f=0;f<e.databases.length;f++)o.push(e.databases[f].name),u.push(e.databases[f].table.length),rgba=e.getRGBA(),r.push(rgba[0]),g.push(rgba[1]),e.dbColors.push({db_name:e.databases[f].name,color:rgba});new Chart(d,{type:'pie',data:{labels:o,datasets:[{label:'Number of table(s)',data:u,backgroundColor:r,borderColor:g,borderWidth:1}]}});e.readyDBChart=!0},e.loadChartNbTuplesInTable=function(d){canvas=document.getElementById('nbTuplesInTable'),canvas.id+=d;var o=document.getElementById('nbTuplesInTable'+d),u=[],r=[],g=[],b=[],f=e.getRGBA();for(let p=0;p<e.databases.length;p++)for(let B=0;B<e.databases[p].table.length;B++)if(e.databases[p].name==d&&!isInExceptionTables(e.databases[p].table[B].table_name)){for(let I=0;I<e.dbColors.length;I++)e.databases[p].name==e.dbColors[I].db_name&&(f=e.dbColors[I].color);u.push(e.splitTheTableName(e.databases[p].table[B].table_name)),r.push(e.databases[p].table[B].values.length),g.push(f[0]),b.push(f[1])}new Chart(o,{type:'bar',data:{labels:u,datasets:[{label:'Number of record(s) in '+d,data:r,backgroundColor:g,borderColor:b,borderWidth:1}]},options:{scales:{yAxes:[{ticks:{beginAtZero:!0}}]}}})},e.loadChartDbMemory=function(){var d=$('#dbMemory'),o=[],u=[],r=[],g=[],b=e.getRGBA();for(let h=0;h<e.databases.length;h++){for(let p=0;p<e.dbColors.length;p++)e.databases[h].name==e.dbColors[p].db_name&&(b=e.dbColors[p].color);o.push(e.databases[h].name),u.push(e.databases[h].size),r.push(b[0]),g.push(b[1])}new Chart(d,{type:'pie',data:{labels:o,datasets:[{label:'Memory of database(s) in Mb',data:u,backgroundColor:r,borderColor:g,borderWidth:1}]}})},e.loadChartSondeTenant=function(d){canvas=document.getElementById('sondeTenant'),canvas.id+=d.datasets.label;var o=document.getElementById('sondeTenant'+d.datasets.label),u=new Chart(o,{type:'bar',data:{labels:d.labels,datasets:[d.datasets]},options:{scales:{yAxes:[{ticks:{beginAtZero:!0}}]}}});canvas.onclick=function(r){var g=u.getElementsAtEvent(r);if(0<g.length){window.location='#!/db_management',e.wait(),s=a.getScope(),null==s&&(e.wait(),s=a.getScope());let b;'Elastic Cloud Server'==g[0]._model.datasetLabel?b='ecs_table':'Security Group'==g[0]._model.datasetLabel?b='sg_table':'Subnet'==g[0]._model.datasetLabel&&(b='subnet_table'),tableSelected='sonde;'+b,s.display('tenant_uuid',e.getIdTenantFromName(g[0]._model.label))}}}}),app.controller('treeDatabaseAreaController',function(e,t,a){e.databases=[];var n=t.getScope();a.setScope(e),e.ready=!1,e.displayNothing=!0,e.displayAdd=!1,e.displayModify=!1,e.displayRelations=!1,e.setDisplayTo=function(s){'nothing'===s?(e.displayNothing=!0,e.displayAdd=!1,e.displayModify=!1,e.displayRelations=!1):'add'===s?(e.displayNothing=!1,e.displayAdd=!0,e.displayModify=!1):'modify'===s?(e.displayNothing=!1,e.displayAdd=!1,e.displayModify=!0,e.displayRelations=!1):'relations'===s?(e.displayNothing=!1,e.displayAdd=!1,e.displayModify=!1,e.displayRelations=!0):console.log('Wrong type for setDisplayTo')},e.loadDB=function(){e.ready||n.getDBName(function(){if(n.successRequest){db=[];for(let s=0;s<n.dbArray.data.length;s++)exceptionDB.includes(n.dbArray.data[s].datname)||db.push(n.dbArray.data[s].datname);for(let s=0;s<db.length;s++)n.getTableName(db[s],function(){n.successRequest?(e.databases.push({name:db[s],table:n.tableArray.data}),s==db.length-1&&(e.ready=!0,$(function(){$('#treeDatabaseArea').jstree()}))):(console.log(n.tableArray),alert('Error on getTableName request, check console logs.'))})}else console.log(n.dbArray),alert('Error on getDBName request, check console logs.')})}}),app.controller('columnsDisplayAreaController',function(e,t,a){t.setScope(e);var n=a.getScope();e.row_ids=[],e.elementIdToSet=[],e.checkIfIsReference=function(s){var d=!1;for(let o=0;o<n.columnConstraint.data.length;o++)if(s===n.columnConstraint.data[o].column_name){d=!0;break}return d},e.setIdForToolTips=function(s,d,o){let u=d+';'+JSON.stringify(s)+';'+o;return e.row_ids.push({id:u,column_name:d,value:o}),''},e.setToolTips=function(){for(let s=0;s<e.row_ids.length;s++)e.checkIfIsReference(e.row_ids[s].column_name)&&null!=document.getElementById(e.row_ids[s].id)&&(document.getElementById(e.row_ids[s].id).title=e.getInfoForFK(e.row_ids[s].column_name,e.row_ids[s].value));e.row_ids=[]},e.getInfoForFK=function(s,d){ret='';for(let o=0;o<n.valuesOfConstraint.length;o++)if(s===n.valuesOfConstraint[o].name){for(let u=0;u<n.valuesOfConstraint[o].values.length;u++)if(n.valuesOfConstraint[o].values[u].id===d){keys=Object.keys(n.valuesOfConstraint[o].values[u].records);for(let r=0;r<keys.length;r++)ret+=n.valuesOfConstraint[o].values[u].records[keys[r]]+' / ';ret=ret.substring(0,ret.length-3);break}break}return ret},e.clearTooltips=function(){listTD=document.getElementsByTagName('TD');for(let s=0;s<listTD.length;s++)listTD[s].title=''},e.setName=function(s,d,o){id=s+';'+JSON.stringify(d)+';'+o,e.elementIdToSet.push({id:id,column:s,set:!1,value:o})},e.setNameWithId=function(){if(null!=n.valuesOfConstraint)for(let s=0;s<n.valuesOfConstraint.length;s++)for(let d=0;d<e.elementIdToSet.length;d++)if(n.valuesOfConstraint[s].name==e.elementIdToSet[d].column&&!e.elementIdToSet[d].set)for(let o=0;o<n.valuesOfConstraint[s].values.length;o++)n.valuesOfConstraint[s].values[o].id==e.elementIdToSet[d].value&&null!=document.getElementById(e.elementIdToSet[d].id)&&(document.getElementById(e.elementIdToSet[d].id).innerHTML=n.valuesOfConstraint[s].values[o].name,e.elementIdToSet[d].set=!0)}}),app.controller('buttonAreaController',function(e,t,a,n,s){n.setScope(e);var d=a.getScope(),o=t.getScope(),u=s.getScope(),r=!1,g=tableSelected,b=rowSelected;null!=document.getElementById('displayButton')&&(document.getElementById('displayButton').disabled=!0),null!=document.getElementById('addButton')&&(document.getElementById('addButton').disabled=!0),null!=document.getElementById('modifyButton')&&(document.getElementById('modifyButton').disabled=!0),null!=document.getElementById('deleteButton')&&(document.getElementById('deleteButton').disabled=!0),null!=document.getElementById('clearButton')&&(document.getElementById('clearButton').disabled=!1),null!=document.getElementById('showRelationsButton')&&(document.getElementById('showRelationsButton').disabled=!0),e.display=function(f,h){busy=!1,g=tableSelected,b=rowSelected;var p=!0,B=t.getScope();if(u.setDisplayTo('nothing'),null!=b&&(document.getElementById(b).style.backgroundColor=''),rowSelected=null,B.row_ids=[],B.elementIdToSet=[],B.clearTooltips(),null!=g){let I=g.split(';'),E=I[0];r=checkIfReadOnlyDB(E)}if(document.getElementById('columnsDisplayArea').style.display='block',r?(null!=document.getElementById('addButton')&&(document.getElementById('addButton').disabled=!0),null!=document.getElementById('modifyButton')&&(document.getElementById('modifyButton').disabled=!0),null!=document.getElementById('deleteButton')&&(document.getElementById('deleteButton').disabled=!0),null!=document.getElementById('showRelationsButton')&&(document.getElementById('showRelationsButton').disabled=!0)):(null!=document.getElementById('modifyButton')&&(document.getElementById('modifyButton').disabled=!0),null!=document.getElementById('deleteButton')&&(document.getElementById('deleteButton').disabled=!0),null!=document.getElementById('showRelationsButton')&&(document.getElementById('showRelationsButton').disabled=!0)),null!=g){let I=g.split(';'),E=I[0],R=I[1];r||(document.getElementById('addButton').disabled=!1),d.getColumnName(E,R,function(){d.successRequest?(B.columns=d.columnsArray.data,d.getAllValues(E,R,function(){if(d.successRequest){B.tuples=[];for(let C=0;C<d.columnValues.data.length;C++){I=[];for(let q,_=0;_<B.columns.length;_++){q=d.columnValues.data[C][B.columns[_].column_name];for(let v=0;v<displayName.length;v++)if(null!=d.columnValues.data[C][displayName[v]]){q=d.columnValues.data[C][displayName[v]];break}p=null!=f&&null!=h?B.columns[_].column_name==f&&d.columnValues.data[C][B.columns[_].column_name]==h:!0,I.push(d.columnValues.data[C][B.columns[_].column_name])}p&&B.tuples.push({column_names:B.columns,values:I})}}else console.log(d.columnValues),alert('Error on getAllValues request, check console logs.')}),d.getColumnConstraint(E,R,function(){if(d.successRequest){d.valuesOfConstraint=[];for(let _,C=0;C<d.columnConstraint.data.length;C++)_=[],d.getValuesOf(E,d.columnConstraint.data[C].foreign_table_name,'*',function(){if(d.successRequest){for(let q=0;q<d.valuesOf.data.length;q++){let v=null,T=null;for(let w=0;w<displayName.length;w++)if(null!=d.valuesOf.data[q][displayName[w]]){v=d.valuesOf.data[q][displayName[w]],T=displayName[w];break}_.push({id:d.valuesOf.data[q][d.columnConstraint.data[C].foreign_column_name],name:v,table:d.columnConstraint.data[C].foreign_table_name,records:d.valuesOf.data[q]})}d.valuesOfConstraint.push({name:d.columnConstraint.data[C].column_name,values:_}),B.setToolTips()}else console.log(d.valuesOf),alert('Error on getValuesOf request, check console logs.')});B.setNameWithId()}else console.log(d.columnConstraint),alert('Error on getColumnConstraint request, check console logs.')})):(console.log(d.columnsArray),alert('Error on getColumnName request, check console logs.'))})}},e.add=function(){r||(null!=document.getElementById('addButton')&&(document.getElementById('addButton').disabled=!0),null!=document.getElementById('modifyButton')&&(document.getElementById('modifyButton').disabled=!0),null!=document.getElementById('deleteButton')&&(document.getElementById('deleteButton').disabled=!0),null!=document.getElementById('showRelationsButton')&&(document.getElementById('showRelationsButton').disabled=!0),u.setDisplayTo('add'),busy=!0)},e.modify=function(){r||(null!=document.getElementById('addButton')&&(document.getElementById('addButton').disabled=!0),null!=document.getElementById('modifyButton')&&(document.getElementById('modifyButton').disabled=!0),null!=document.getElementById('deleteButton')&&(document.getElementById('deleteButton').disabled=!0),null!=document.getElementById('showRelationsButton')&&(document.getElementById('showRelationsButton').disabled=!0),u.setDisplayTo('modify'),busy=!0)},e.delete=function(){if(b=rowSelected,g=tableSelected,confirm('Do you want to delete this record ?')&&null!=g){let f=g.split(';'),h=f[0],p=f[1];d.getPrimaryKey(h,p,function(){if(d.successRequest){for(let I=0;I<o.columns.length;I++)if(d.primaryKey.data[0].attname===o.columns[I].column_name){var B=JSON.parse(b)[I];break}d.delRecord(h,p,d.primaryKey.data[0].attname,B,function(){d.successRequest?(e.display(),rowSelected=null):(console.log(d.deleteRequest),alert('Error on delRecord request, check console logs.'))})}else console.log(d.primaryKey),alert('Error on getPrimaryKey request, check console logs.')})}},e.clear=function(){null!=document.getElementById('columnsDisplayArea')&&(document.getElementById('columnsDisplayArea').style.display='none'),r||(null!=document.getElementById('addButton')&&(document.getElementById('addButton').disabled=!0),null!=document.getElementById('modifyButton')&&(document.getElementById('modifyButton').disabled=!0),null!=document.getElementById('deleteButton')&&(document.getElementById('deleteButton').disabled=!0),null!=u&&u.setDisplayTo('nothing')),null!=rowSelected&&null!=document.getElementById(rowSelected)&&(document.getElementById(rowSelected).style.backgroundColor=''),rowSelected=null,busy=!1,u.setDisplayTo('nothing')},e.showRelations=function(){r||(null!=document.getElementById('addButton')&&(document.getElementById('addButton').disabled=!0),null!=document.getElementById('modifyButton')&&(document.getElementById('modifyButton').disabled=!0),null!=document.getElementById('deleteButton')&&(document.getElementById('deleteButton').disabled=!0)),busy=!0,null!=document.getElementById('showRelationsButton')&&(document.getElementById('showRelationsButton').disabled=!0),u.setDisplayTo('relations')}}),app.controller('addRowAreaController',function(e,t,a,n,s){var d=t.getScope(),o=a.getScope(),u=n.getScope(),r=s.getScope(),g=tableSelected,b=rowSelected;d.row_ids=[],e.references=[],e.attributes=[];for(let f=0;f<d.columns.length;f++)exceptionColumns.includes(d.columns[f].column_name)||e.attributes.push(d.columns[f]);if(null!=g)for(let h,f=0;f<e.attributes.length;f++){h=[];for(let B=0;B<o.valuesOfConstraint.length;B++)if(e.attributes[f].column_name==o.valuesOfConstraint[B].name){for(let I=0;I<o.valuesOfConstraint[B].values.length;I++)theName=null==o.valuesOfConstraint[B].values[I].name?o.valuesOfConstraint[B].values[I].id:o.valuesOfConstraint[B].values[I].name,h.push({id:o.valuesOfConstraint[B].values[I].id,name:theName});break}let p={};p[e.attributes[f].column_name]=h,e.references.push(p)}e.checkIfIsReference=function(f){var h=!1;if(null!=g)for(let p=0;p<o.columnConstraint.data.length;p++)if(f===o.columnConstraint.data[p].column_name){h=!0;break}return h},e.saveRecord=function(){var f=!1;if(confirm('Are you sure you want to save this record ?')){if(null!=g){let h=g.split(';'),p=h[0],B=h[1];columnList=[];for(let I=0;I<e.attributes.length;I++)columnList.push(e.attributes[I].column_name);valueList=[];for(let E,I=0;I<columnList.length;I++)if(E=document.getElementById(columnList[I]),'INPUT'===E.nodeName){if(null==E.value)valueList.push('');else if(e.attributes[I].data_type.toLowerCase().includes('int'))valueList.push(parseInt(E.value));else if(containsForbiddenChar(E.value)){f=!0;break}else f=!1,valueList.push(E.value);}else if('SELECT'===E.nodeName)if(null==E.selectedIndex||null==E.options[E.selectedIndex])valueList.push('');else if(e.attributes[I].data_type.toLowerCase().includes('int'))valueList.push(parseInt(E.options[E.selectedIndex].value));else if(containsForbiddenChar(E.options[E.selectedIndex].value)){f=!0;break}else f=!1,valueList.push(E.options[E.selectedIndex].value);f||o.addRecord(p,B,columnList,valueList,function(){o.successRequest?(u.display(),null!=b&&(null!=document.getElementById('modifyButton')&&(document.getElementById('modifyButton').disabled=!0),null!=document.getElementById('deleteButton')&&(document.getElementById('deleteButton').disabled=!0),null!=b&&(document.getElementById(b).style.backgroundColor=''),null!=b&&(document.getElementById(b).style.backgroundColor=''),rowSelected=null)):(console.log(o.addRequest),alert('Error on addRecord request, check console logs.'))})}f?alert('You cannot add elements with forbidden characters'):(r.setDisplayTo('nothing'),document.getElementById('addButton').disabled=!1,document.getElementById('modifyButton').disabled=!1,busy=!1)}},e.cancelRecord=function(){confirm('Are you sure you want to cancel ?')&&(r.setDisplayTo('nothing'),document.getElementById('addButton').disabled=!1,document.getElementById('modifyButton').disabled=!0,null!=b&&(document.getElementById(b).style.backgroundColor=''),null!=b&&(document.getElementById(b).style.backgroundColor=''),rowSelected=null,busy=!1)},e.setIdForToolTips=function(f,h){ret='';d.row_ids.push({id:'a'+h+f,column_name:h,value:f});for(let B=0;B<d.row_ids.length;B++)d.checkIfIsReference(d.row_ids[B].column_name)&&null!=document.getElementById(d.row_ids[B].id)&&(ret=d.getInfoForFK(d.row_ids[B].column_name,d.row_ids[B].value));return ret}}),app.controller('modifyRowAreaController',function(e,t,a,n,s){var d=t.getScope(),o=a.getScope(),u=n.getScope(),r=s.getScope(),g=rowSelected,b=tableSelected;d.row_ids=[],e.attributes=[];let f=JSON.parse(g);for(let h=0;h<d.columns.length;h++)exceptionColumns.includes(d.columns[h].column_name)||e.attributes.push({name:d.columns[h],value:f[h]});if(e.references=[],null!=b)for(let p,h=0;h<e.attributes.length;h++){p=[];for(let I=0;I<o.valuesOfConstraint.length;I++)if(e.attributes[h].name.column_name==o.valuesOfConstraint[I].name){for(let E=0;E<o.valuesOfConstraint[I].values.length;E++)theName=null==o.valuesOfConstraint[I].values[E].name?o.valuesOfConstraint[I].values[E].id:o.valuesOfConstraint[I].values[E].name,p.push({id:o.valuesOfConstraint[I].values[E].id,name:theName});break}let B={};B[e.attributes[h].name.column_name]=p,e.references.push(B)}e.saveRecord=function(){var h=!1;if(confirm('Are you sure you want to save this record ?')&&null!=b){let p=b.split(';'),B=p[0],I=p[1];columnList=[];for(let E=0;E<e.attributes.length;E++)columnList.push(e.attributes[E].name.column_name);valueList=[];for(let R,E=0;E<columnList.length;E++)if(R=document.getElementById(columnList[E]),'INPUT'===R.nodeName){if(null==R.value)valueList.push('');else if(e.attributes[E].name.data_type.toLowerCase().includes('int'))valueList.push(parseInt(R.value));else if(containsForbiddenChar(R.value)){h=!0;break}else h=!1,valueList.push(R.value);}else if('SELECT'===R.nodeName)if(null==R.selectedIndex||null==R.options[R.selectedIndex])valueList.push('');else if(e.attributes[E].name.data_type.toLowerCase().includes('int'))valueList.push(parseInt(R.options[R.selectedIndex].value));else if(containsForbiddenChar(R.options[R.selectedIndex].value)){h=!0;break}else h=!1,valueList.push(R.options[R.selectedIndex].value);h||o.getPrimaryKey(B,I,function(){if(o.successRequest){for(let R=0;d.columns.length;R++)if(o.primaryKey.data[0].attname===d.columns[R].column_name){var E=JSON.parse(g)[R];break}o.modifyRecord(B,I,columnList,valueList,o.primaryKey.data[0].attname,E,function(){o.successRequest?(u.display(),document.getElementById('modifyButton').disabled=!0,null!=rowSelected&&(document.getElementById(rowSelected).style.backgroundColor=''),null!=g&&(document.getElementById(g).style.backgroundColor=''),rowSelected=null):(console.log(o.modifyRequest),alert('Error on getPrimaryKey request, check console logs.'))})}else console.log(o.primaryKey),alert('Error on getPrimaryKey request, check console logs.')}),h?alert('You cannot modify elements with forbidden characters'):(r.setDisplayTo('nothing'),document.getElementById('addButton').disabled=!1,document.getElementById('modifyButton').disabled=!1,busy=!1)}},e.cancelRecord=function(){confirm('Are you sure you want to cancel ?')&&(r.setDisplayTo('nothing'),document.getElementById('addButton').disabled=!1,document.getElementById('modifyButton').disabled=!0,null!=rowSelected&&(document.getElementById(rowSelected).style.backgroundColor=''),null!=g&&(document.getElementById(g).style.backgroundColor=''),rowSelected=null,busy=!1)},e.checkIfIsReference=function(h){var p=!1;if(null!=b)for(let B=0;B<o.columnConstraint.data.length;B++)if(h===o.columnConstraint.data[B].column_name){p=!0;break}return p},e.setIdForToolTips=function(h,p){ret='';d.row_ids.push({id:'m'+p+h,column_name:p,value:h});for(let I=0;I<d.row_ids.length;I++)d.checkIfIsReference(d.row_ids[I].column_name)&&null!=document.getElementById(d.row_ids[I].id)&&(ret=d.getInfoForFK(d.row_ids[I].column_name,d.row_ids[I].value));return ret}}),app.controller('relationsAreaController',function(e,t,a,n){var s=t.getScope(),d=a.getScope(),o=n.getScope();e.relationsData=[],e.ready=!1,e.displayRel=function(){if(currentTableSelected=tableSelected,currentRowSelected=rowSelected,e.relationsData=[],e.ready=!1,null!=currentTableSelected){let u=currentTableSelected.split(';'),r=u[0],g=u[1];s.getPrimaryKey(r,g,function(){if(s.successRequest){var b=s.primaryKey.data[0].attname;for(let h=0;h<d.columns.length;h++)if(b==d.columns[h].column_name){var f=JSON.parse(currentRowSelected)[h];break}for(let h=0;h<o.databases.length;h++)if(o.databases[h].name==r){for(let p=0;p<o.databases[h].table.length;p++)o.databases[h].table[p].table_name!=g&&s.getColumnConstraint(r,o.databases[h].table[p].table_name,function(){if(s.successRequest)for(let B=0;B<s.columnConstraint.data.length;B++){if(s.columnConstraint.data[B].foreign_table_name==g&&s.columnConstraint.data[B].foreign_column_name==b){col=s.columnConstraint.data[B].column_name,s.getPrimaryKey(r,s.columnConstraint.data[B].table_name,function(){s.successRequest&&s.query(r,o.databases[h].table[p].table_name,'*',col,f,function(){if(s.successRequest){let I=s.primaryKey.data[0].attname;if(0<s.queryRequest.data.length)for(let E=0;E<displayName.length;E++)if(null!=s.queryRequest.data[0][displayName[E]]){I=displayName[E];break}e.relationsData.push({table_name:o.databases[h].table[p].table_name,values:s.queryRequest.data,id:s.primaryKey.data[0].attname,name:I})}else console.log(s.queryRequest),alert('Error on query request, check console logs.')})});break}break}else console.log(s.columnConstraint),alert('Error on getColumnConstraint request, check console logs.')});break}e.ready=!0}else console.log(s.primaryKey),alert('Error on getPrimaryKey request, check console logs.')})}},e.clear=function(){busy=!1,e.relationsData=[],e.ready=!1,o.setDisplayTo('nothing'),null!=document.getElementById('showRelationsButton')&&(document.getElementById('showRelationsButton').disabled=!1)}}),app.controller('loginController',function(e,t,a,n,s){s.setScope(e);var o=n.getScope(),u=0.041;e.iden=function(){var g=document.getElementById('user').value,b=document.getElementById('pass').value,f=document.getElementById('check');e.getMD5(g+b,function(){e.successRequest?e.check_login(e.md5.data,f):(console.log(e.md5),alert('Error on getMD5, check console logs.'))})},e.clear_cook=function(){e.createCookie('identifiant','',-1),e.createCookie('date','',-1),window.location='#!/login'},e.verifco=function(){for(var I,r=document.getElementById('connexion'),g=document.getElementById('inscription'),b='date=',f='',h=decodeURIComponent(document.cookie),p=h.split(';'),B=0;B<p.length;B++){for(I=p[B];' '==I.charAt(0);)I=I.substring(1);0==I.indexOf(b)&&(f=I.substring(b.length,I.length))}b='identifiant=';for(var I,E='',h=decodeURIComponent(document.cookie),p=h.split(';'),B=0;B<p.length;B++){for(I=p[B];' '==I.charAt(0);)I=I.substring(1);0==I.indexOf(b)&&(E=I.substring(b.length,I.length))}null==r&&null==g&&(''==f&&''==E?window.location='#!/login':e.createCookie('date','1',u))},e.isLoggedOn=function(){for(var p,r='date=',g='',b=decodeURIComponent(document.cookie),f=b.split(';'),h=0;h<f.length;h++){for(p=f[h];' '==p.charAt(0);)p=p.substring(1);0==p.indexOf(r)&&(g=p.substring(r.length,p.length))}r='identifiant=';for(var p,B='',b=decodeURIComponent(document.cookie),f=b.split(';'),h=0;h<f.length;h++){for(p=f[h];' '==p.charAt(0);)p=p.substring(1);0==p.indexOf(r)&&(B=p.substring(r.length,p.length))}return ret=!1,(''!=g||''!=B)&&(ret=!0),ret},e.check_login=function(r,g){e.getIdFromMD5(r,function(){e.successRequest?0<e.queryLogin.data.length?(g.checked&&e.createCookie('identifiant',r,31),window.location='/',e.createCookie('date','1',u)):alert('Id or password incorrect'):(console.log(e.queryLogin),alert('Error on getIdFromMD5 request, check console logs.'))})},e.readCookie=function(){var r='date=';cook='';for(var f,g=document.cookie.split(';'),b=0;b<g.length;b++){for(f=g[b];' '==f.charAt(0);)f=f.substring(1);0==f.indexOf(r)&&(cook=f.substring(r.length,f.length))}alert(cook)},e.createCookie=function(r,g,b){if(b){var f=new Date;f.setTime(f.getTime()+1e3*(60*(60*(24*b))));var h='; expires='+f.toGMTString()}else var h='';document.cookie=r+'='+g+h+'; path=/'},e.getIdFromMD5=function(r,g){t({method:'GET',url:'/login/getIdFromMD5?md5='+r}).then(function(f){e.successRequest=!0,e.queryLogin=f,g&&g()},function(f){e.successRequest=!1,e.queryLogin=f,g&&g()})},e.addLogin=function(r,g,b,f,h,p){t({method:'POST',url:'/login/addLogin?id='+r+'&md5='+g+'&mail='+b+'&md5NameMail='+f+'&validate='+h}).then(function(I){e.successRequest=!0,e.addLogin=I,p&&p()},function(I){e.successRequest=!1,e.addLogin=I,p&&p()})},e.getMD5=function(r,g){t({method:'GET',url:'/login/getTheMd5?up='+r}).then(function(f){e.successRequest=!0,e.md5=f,g&&g()},function(f){e.successRequest=!1,e.md5=f,g&&g()})},e.getIdFromMd5NameMail=function(r,g){t({method:'GET',url:'/login/getIdFromMd5NameMail?md5namemail='+r}).then(function(f){e.successRequest=!0,e.md5NameMail=f,g&&g()},function(f){e.successRequest=!1,e.md5NameMail=f,g&&g()})},e.reload=function(){a.reload()}}),app.controller('signupController',function(e,t,a,n){var s=a.getScope(),d=n.getScope();e.normalizeStr=function(o){return o.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(' ','+')},e.checkInfo=function(){var o=document.getElementById('user').value,u=document.getElementById('pass').value,r=document.getElementById('repass').value,g=document.getElementById('mail').value,b=document.getElementById('nom').value,f=document.getElementById('prenom').value,B=e.normalizeStr(b),I=e.normalizeStr(f),E=g.replace('@','%40');u===r?e.areCorrectParam([o,u,g,b,f])?e.getAnnuaire('http://annuaire.sso.infra.ftgroup/persons?searchType=PERSON_COMPLEX&personCriteriaN='+B+'&personCriteriaP='+I+'&personCriteriaM='+E,function(){e.successRequest?e.annuaire.data.includes('Aucun r\xE9sultat trouv\xE9. Relancer la requ\xEAte sur des crit\xE8res diff\xE9rents')?alert('You cannot register with the giving information, please try again or contact your administrator.'):e.annuaire.data.includes('Profil de')?d.getMD5(b+f+g,function(){if(d.successRequest){var _=d.md5.data;d.getIdFromMd5NameMail(d.md5.data,function(){d.successRequest?''!=d.md5NameMail.data||null!=d.md5NameMail.data.length&&0<d.md5NameMail.data.length?alert('An account already exists for this person.'):d.getMD5(o+u,function(){d.successRequest?d.addLogin(o,d.md5.data,g,_,!0,function(){d.successRequest?(alert('You have been registered.'),window.location='#!/login'):(console.log(d.addLogin),alert('Error on addLogin request, check console logs.'))}):(console.log(d.md5),alert('Error on getMD5 request, check console logs.'))}):(console.log(d.md5NameMail),alert('Error on getIdFromMd5NameMail request, check console logs.'))})}else console.log(d.md5),alert('Error on getMD5 request, check console logs.')}):console.log('Unhandle'):(console.log(e.annuaire),alert('Error on getAnnuaire request, check console logs.'))}):alert('Invalid parameters, try again.'):alert('The 2 passwords don\'t match.')},e.getAnnuaire=function(o,u){t({method:'GET',url:'/web/getAnnuaire?lien='+o}).then(function(g){e.successRequest=!0,e.annuaire=g,u&&u()},function(g){e.successRequest=!1,e.annuaire=g,u&&u()})},e.areCorrectParam=function(o){var u=!0;for(let r=0;r<o.length;r++)if(''==o[r]||containsForbiddenChar(o[r])){u=!1;break}return u}});
